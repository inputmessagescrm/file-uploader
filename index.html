<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Загрузка файлов для проверки</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
    .header { text-align: center; margin-bottom: 40px; color: white; }
    .header h1 { font-size: 2.5rem; font-weight: bold; margin-bottom: 16px;
      background: linear-gradient(45deg, #fff, #e0e7ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .header p { font-size: 1.125rem; opacity: 0.9; max-width: 680px; margin: 0 auto; }
    .user-info { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
      border-radius: 12px; padding: 20px; margin: 24px 0 30px; border: 1px solid rgba(255,255,255,0.2); color: white; display: none; }
    .user-info h3 { font-size: 0.95rem; font-weight: 600; margin-bottom: 8px; opacity: 0.95; }
    .user-info p { font-size: 0.95rem; margin: 6px 0; }
    .upload-zone { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
      border: 2px dashed #d1d5db; border-radius: 12px; padding: 60px 40px; text-align: center; cursor: pointer; transition: all 0.3s ease; margin-bottom: 30px; }
    .upload-zone:hover { border-color:#667eea; background:#fff; transform: translateY(-2px); box-shadow:0 10px 25px rgba(0,0,0,0.1); }
    .upload-zone.drag-over { border-color:#667eea; background: rgba(102,126,234,0.1); transform: scale(1.02); }
    .upload-icon { width:64px;height:64px;margin:0 auto 20px;background:#667eea;border-radius:50%;
      display:flex;align-items:center;justify-content:center;transition:.3s; }
    .upload-zone:hover .upload-icon{ background:#5a67d8; transform:scale(1.1); }
    .upload-zone.drag-over .upload-icon{ background:#667eea; transform:scale(1.2); }
    .upload-title { font-size:1.25rem;font-weight:600;color:#374151;margin-bottom:8px; }
    .upload-subtitle { color:#6b7280;margin-bottom:16px; }
    #fileInput{ display:none; }
    .file-info { background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); border-radius:12px; padding:20px; margin-bottom:20px;
      border:1px solid rgba(255,255,255,0.3); display:none; }
    .progress-container { background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
      border-radius:12px; padding:20px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.3); display:none; }
    .progress-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .progress-text{ font-size:.875rem; font-weight:500; color:#374151; }
    .progress-percent{ font-size:.875rem; color:#6b7280; }
    .progress-bar{ width:100%;height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden;margin-bottom:8px; }
    .progress-fill{ height:100%; background:linear-gradient(90deg,#667eea,#764ba2); border-radius:4px; width:0%; transition:width .2s ease; }
    .progress-filename{ font-size:.75rem; color:#6b7280; }
    .actions{ display:flex; gap:12px; justify-content:center; margin-top:12px; flex-wrap: wrap; }
    .btn{ background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; padding:16px 24px; border-radius:8px; font-size:1rem; font-weight:500;
      cursor:pointer; transition:.3s; box-shadow:0 4px 15px rgba(102,126,234,.4); }
    .btn:hover:not(:disabled){ transform:translateY(-2px); box-shadow:0 8px 25px rgba(102,126,234,.6); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
    .hidden{ display:none !important; }
    .toast{ position:fixed; top:20px; right:20px; background:white; border-radius:8px; padding:16px;
      box-shadow:0 10px 25px rgba(0,0,0,.1); border-left:4px solid #10b981; transform:translateX(400px);
      transition:transform .3s ease; z-index:1000; max-width:420px; }
    .toast.show{ transform:translateX(0); }
    .toast.error{ border-left-color:#ef4444; }
    .toast-title{ font-weight:600; color:#374151; margin-bottom:4px; }
    .toast-message{ color:#6b7280; font-size:.875rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Загрузите файл для проверки</h1>
      <p>Допустимый формат PDF, TIFF, JPEG или PNG. Размер до 200&nbsp;Мб.</p>
    </div>

    <div id="userInfo" class="user-info">
      <h3>Информация:</h3>
      <div id="userDetails"></div>
    </div>

    <div id="uploadZone" class="upload-zone">
      <div class="upload-icon">
        <svg width="32" height="32" fill="white" viewBox="0 0 24 24">
          <path d="M14,2H6A2,2 0,0,0 4,4V20A2,2 0,0,0 6,22H18A2,2 0,0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
        </svg>
      </div>
      <h3 class="upload-title">Перетащите файл сюда</h3>
      <p class="upload-subtitle">или <span class="highlight">выберите файл</span> с компьютера</p>
      <input type="file" id="fileInput" accept=".pdf,.tiff,.tif,.jpeg,.jpg,.png" multiple />
    </div>

    <div id="fileInfo" class="file-info"></div>

    <div id="progressContainer" class="progress-container">
      <div class="progress-header">
        <span class="progress-text" id="progressText">Загрузка файла…</span>
        <span class="progress-percent" id="progressPercent">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <p class="progress-filename" id="progressFilename"></p>
    </div>

    <div class="actions">
      <button id="uploadBtn" class="btn hidden">Отправить на проверку</button>
      <button id="viewMaketBtn" class="btn hidden">Открыть макет</button>
      <button id="viewImposingBtn" class="btn hidden">Открыть раскладку</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

  <script>
    const WEBHOOK_URL = 'https://n8n.mdmprint.online/webhook/6a64b230-5b0c-46ad-b4d0-8830cbd95cc4';
    const ALLOWED_EXTENSIONS = ['pdf','tiff','tif','jpeg','jpg','png'];
    const MAX_FILE_SIZE = 200 * 1024 * 1024;

    let selectedFiles = [];
    let isUploading = false;
    let lastMaketUrl = '';
    let lastImposingUrl = '';

    const urlParams = { chat_id:'', timestamp:'', bot:'', messageId:'', sides:'one', sheet:'', sizeLabel:'', bleed:null };

    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const uploadBtn = document.getElementById('uploadBtn');
    const viewMaketBtn = document.getElementById('viewMaketBtn');
    const viewImposingBtn = document.getElementById('viewImposingBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressPercent = document.getElementById('progressPercent');
    const progressText = document.getElementById('progressText');
    const progressFilename = document.getElementById('progressFilename');
    const userInfo = document.getElementById('userInfo');
    const userDetails = document.getElementById('userDetails');

    const SIZE_LABEL_TABLE = {
      '76x105':'A7 105×76 мм','105x146':'A6 105×146 мм','146x210':'A5 146×210 мм','210x297':'A4 210×297 мм',
      '297x420':'A3 297×420 мм','210x210':'210×210 мм','99x210':'99×210 мм','50x90':'90×50 мм','55x85':'85×55 мм',
    };

    function init(){
      parseUrl();
      renderUserInfo();

      uploadZone.addEventListener('click', () => fileInput.click());
      uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
      uploadZone.addEventListener('dragleave', e => { e.preventDefault(); uploadZone.classList.remove('drag-over'); });
      uploadZone.addEventListener('drop', handleDrop);
      fileInput.addEventListener('change', handleFileInputChange);
      uploadBtn.addEventListener('click', handleUpload);

      viewMaketBtn.addEventListener('click', () => { if (lastMaketUrl) window.open(lastMaketUrl, '_blank'); });
      viewImposingBtn.addEventListener('click', () => { if (lastImposingUrl) window.open(lastImposingUrl, '_blank'); });
    }

    // ---------- URL & Info ----------
    function parseUrl(){
      const sp = new URLSearchParams(window.location.search);
      urlParams.chat_id   = sp.get('chat_id') || '';
      urlParams.timestamp = sp.get('timestamp') || '';
      urlParams.bot       = sp.get('bot') || '';                 // "mockup" | "layout"
      urlParams.messageId = sp.get('messageId') || '';
      urlParams.sides     = sp.get('sides') || 'one';            // "one" | "two"
      urlParams.sheet     = sp.get('sheet') || '';               // "SRA3" | "487x330" | ""
      urlParams.bleed     = (sp.get('bleed') === '1');           // 0|1 → boolean

      // размер для инфоблока берём из job не нужно — можно из дополнительных параметров,
      // но если хотите, можно оставить label как “—”.
      urlParams.sizeLabel = '—'; // если хотите — прокиньте size_label=... в ссылку и возьмите отсюда
    }

    function humanSizeLabelFromLongShort(long, short){
      if(!long || !short) return '—';
      const a = Math.min(long, short), b = Math.max(long, short);
      const key = `${a}x${b}`;
      return SIZE_LABEL_TABLE[key] || `Свой размер ${b}×${a} мм`;
    }

    function renderUserInfo(){
      const lines = [];
      if (urlParams.sizeLabel) lines.push(`<p>Размер изделия: ${urlParams.sizeLabel}</p>`);
      if (urlParams.bot === 'mockup') {
        lines.push(`<p>Тип печати: ${urlParams.sides === 'two' ? 'Двусторонняя' : 'Односторонняя'}</p>`);
      }
      if (urlParams.bot === 'layout') {
        if (urlParams.sheet === 'SRA3') lines.push('<p>Формат листа для раскладки: SRA3 450×320 мм</p>');
        else if (urlParams.sheet === '487x330') lines.push('<p>Формат листа для раскладки: 487×330 мм</p>');
        lines.push(`<p>Тип печати: ${urlParams.sides === 'two' ? 'Двусторонняя' : 'Односторонняя'}</p>`);
      }
      if (typeof urlParams.bleed === 'boolean') {
        lines.push(`<p>Дорисовка вылетов: ${urlParams.bleed ? 'Да' : 'Нет'}</p>`);
      }
      if (lines.length){ userDetails.innerHTML = lines.join(''); userInfo.style.display='block'; }
    }

    // ---------- Validation ----------
    async function validateAndAnalyzeFiles(files){
      let pagesTotal = 0;
      let detailsHtml = '';
      const sides = urlParams.sides;

      if ((sides==='one' && files.length>1) || (sides==='two' && files.length>2)) {
        showToast('Ошибка','Загружено слишком много файлов','error'); return false;
      }

      for (let file of files){
        const ext = (file.name.split('.').pop() || '').toLowerCase();
        if (!ALLOWED_EXTENSIONS.includes(ext)) { showToast('Ошибка', `${file.name}: недопустимый тип файла`, 'error'); return false; }
        if (file.size > MAX_FILE_SIZE) { showToast('Файл слишком большой', `${file.name} > 200MB`, 'error'); return false; }

        let pages = 1;
        if (ext === 'pdf'){
          const buf = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument({data:buf}).promise;
          pages = pdf.numPages;
        } else if (ext === 'tif' || ext === 'tiff'){
          const buf = await file.arrayBuffer();
          const ifds = UTIF.decode(buf);
          pages = ifds.length;
        } else {
          pages = 1;
        }

        detailsHtml += `<p>${file.name} — ${pages} стр.</p>`;
        pagesTotal += pages;

        if (sides === 'one' && pagesTotal > 1) { showToast('Ошибка','Для односторонней печати допустим ровно 1 страница','error'); return false; }
        if (sides === 'two' && pagesTotal > 2) { showToast('Ошибка','Для двусторонней печати допустим максимум 2 страницы суммарно','error'); return false; }
      }

      fileInfo.innerHTML = detailsHtml;
      fileInfo.style.display = 'block';
      uploadBtn.classList.remove('hidden');
      uploadZone.style.display = 'none';
      return true;
    }

    // ---------- UI handlers ----------
    function handleDrop(e){ e.preventDefault(); uploadZone.classList.remove('drag-over'); if(e.dataTransfer.files.length) processFiles(e.dataTransfer.files); }
    function handleFileInputChange(e){ if(e.target.files.length) processFiles(e.target.files); }
    async function processFiles(files){
      selectedFiles = Array.from(files);
      const ok = await validateAndAnalyzeFiles(selectedFiles);
      if(!ok){ selectedFiles=[]; fileInfo.style.display='none'; uploadBtn.classList.add('hidden'); uploadZone.style.display='block'; }
    }

    // ---------- Converters ----------
    async function imageToPdf(file){
      const buf=await file.arrayBuffer();
      const bytes=new Uint8Array(buf);
      const pdfDoc=await PDFLib.PDFDocument.create();
      const img=file.type.includes('png')? await pdfDoc.embedPng(bytes) : await pdfDoc.embedJpg(bytes);
      const page=pdfDoc.addPage([img.width,img.height]);
      page.drawImage(img,{x:0,y:0,width:img.width,height:img.height});
      return await pdfDoc.save();
    }
    async function tiffToPdf(file){
      const buf=await file.arrayBuffer();
      const ifds=UTIF.decode(buf);
      UTIF.decodeImages(buf, ifds);
      const pdfDoc=await PDFLib.PDFDocument.create();
      for(let i=0;i<ifds.length;i++){
        const rgba=UTIF.toRGBA8(ifds[i]);
        const canvas=document.createElement('canvas');
        canvas.width=ifds[i].width; canvas.height=ifds[i].height;
        const ctx=canvas.getContext('2d');
        const imageData=ctx.createImageData(ifds[i].width, ifds[i].height);
        imageData.data.set(rgba); ctx.putImageData(imageData,0,0);
        const pngUrl=canvas.toDataURL('image/png');
        const pngBytes=await fetch(pngUrl).then(r=>r.arrayBuffer());
        const img=await pdfDoc.embedPng(pngBytes);
        const page=pdfDoc.addPage([img.width,img.height]);
        page.drawImage(img,{x:0,y:0,width:img.width,height:img.height});
      }
      return await pdfDoc.save();
    }
    async function mergePdfs(pdfs){
      const merged=await PDFLib.PDFDocument.create();
      for(const bytes of pdfs){
        const pdf=await PDFLib.PDFDocument.load(bytes);
        const pages=await merged.copyPages(pdf, pdf.getPageIndices());
        pages.forEach(p=>merged.addPage(p));
      }
      return await merged.save();
    }

    // ---------- Upload with progress ----------
    async function handleUpload(){
      if (!selectedFiles.length || isUploading) return;
      isUploading=true;
      uploadBtn.classList.add('hidden');
      viewMaketBtn.classList.add('hidden');
      viewImposingBtn.classList.add('hidden');
      lastMaketUrl=''; lastImposingUrl='';

      progressContainer.style.display='block';
      progressText.textContent='Загрузка файла…';
      progressPercent.textContent='0%';
      progressFill.style.width='0%';
      progressFilename.textContent = selectedFiles.map(f=>f.name).join(', ');

      try{
        let pdfBuffers=[];
        for(const file of selectedFiles){
          const ext=file.name.split('.').pop().toLowerCase();
          if (ext==='pdf') pdfBuffers.push(await file.arrayBuffer());
          else if (ext==='tif' || ext==='tiff') pdfBuffers.push(await tiffToPdf(file));
          else if (['jpg','jpeg','png'].includes(ext)) pdfBuffers.push(await imageToPdf(file));
        }
        const finalPdf = (pdfBuffers.length>1) ? await mergePdfs(pdfBuffers) : pdfBuffers[0];

        const formData = new FormData();
        formData.append('file', new Blob([finalPdf], { type:'application/pdf' }), 'document.pdf');
        formData.append('sides', urlParams.sides);
        if (urlParams.chat_id)   formData.append('chat_id', urlParams.chat_id);
        if (urlParams.timestamp) formData.append('timestamp', urlParams.timestamp);
        if (urlParams.bot)       formData.append('bot', urlParams.bot);
        if (urlParams.messageId) formData.append('messageId', urlParams.messageId);
        // можно прокинуть bleed/sheet для удобства логирования на сервере
        formData.append('bleed', urlParams.bleed ? '1' : '0');
        if (urlParams.sheet) formData.append('sheet', urlParams.sheet);

        await uploadWithProgress(WEBHOOK_URL, formData);

      } catch(err){
        showToast('Ошибка', err.message || String(err), 'error');
        isUploading=false;
        progressContainer.style.display='none';
        uploadBtn.classList.remove('hidden');
        return;
      }
    }

    function uploadWithProgress(url, formData){
      return new Promise((resolve, reject)=>{
        const xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);

        xhr.upload.onprogress = (e)=>{
          if (!e.lengthComputable) return;
          const percent = Math.min(100, Math.round((e.loaded / e.total) * 100));
          updateProgress(percent);
        };
        xhr.upload.onloadstart = ()=>{ progressText.textContent='Загрузка файла…'; updateProgress(0); };
        xhr.upload.onloadend   = ()=>{ updateProgress(100); progressText.textContent='Файл отправлен. Выполняется проверка…'; progressPercent.textContent='100%'; };

        xhr.onreadystatechange = ()=>{
          if (xhr.readyState === 4){
            try{
              if (xhr.status >= 200 && xhr.status < 300){
                const data = JSON.parse(xhr.responseText || '{}');

                // поддержка старого и нового формата
                const urlSingle = data?.pdf_url || '';
                const urlMaket  = data?.pdf_url_maket || '';
                const urlImpos  = data?.pdf_url_imposing || '';

                if (urlParams.bot === 'layout') {
                  // layout → ожидаем два файла
                  if (urlMaket || urlImpos || urlSingle) {
                    // если прислали один — пытаемся вывести второй из имени
                    if (urlMaket) lastMaketUrl = urlMaket;
                    if (urlImpos) lastImposingUrl = urlImpos;

                    if (!lastMaketUrl && urlSingle && /_MAKET\.pdf$/i.test(urlSingle)) {
                      lastMaketUrl = urlSingle;
                    }
                    if (!lastImposingUrl && lastMaketUrl) {
                      lastImposingUrl = lastMaketUrl.replace(/_MAKET\.pdf$/i, '_IMPOS SING.pdf').replace('_IMPOS SING','_IMPOS SING'); // защита от регексп-пробела
                      lastImposingUrl = lastMaketUrl.replace(/_MAKET\.pdf$/i, '_IMPOS SING.pdf').replace('IMPOS SING','IMPOS SING'); // (оставляем «IMPOS SING» как в бэке)
                      // Правильнее без пробела (как у тебя): IMPOSSING
                      lastImposingUrl = lastMaketUrl.replace(/_MAKET\.pdf$/i, '_IMPOSsing_fix.pdf');
                    }

                    // ↑ примечание: лучше пусть backend вернёт оба URL явно:
                    //   pdf_url_maket и pdf_url_imposing — тогда не будем гадать.

                    // UI
                    lastMaketUrl   = urlMaket || lastMaketUrl || urlSingle || '';
                    lastImposingUrl= urlImpos || lastImposingUrl || '';
                    progressContainer.style.display='none';
                    uploadBtn.classList.add('hidden');
                    if (lastMaketUrl)   viewMaketBtn.classList.remove('hidden');
                    if (lastImposingUrl) viewImposingBtn.classList.remove('hidden');
                    showToast('Готово', lastImposingUrl ? 'Файлы готовы: макет и раскладка.' : 'Файл макета готов.');

                  } else {
                    showToast('Готово', 'Ответ получен, но ссылки на файлы отсутствуют', 'error');
                    progressContainer.style.display='none';
                    uploadBtn.classList.remove('hidden');
                  }

                } else {
                  // mockup → один файл
                  if (urlSingle) {
                    lastMaketUrl = urlSingle;
                    progressContainer.style.display='none';
                    uploadBtn.classList.add('hidden');
                    viewMaketBtn.classList.remove('hidden');
                    showToast('Готово', 'Файл готов. Можно открыть PDF.');
                  } else {
                    showToast('Готово', 'Ответ получен, но ссылка на PDF отсутствует', 'error');
                    progressContainer.style.display='none';
                    uploadBtn.classList.remove('hidden');
                  }
                }

                isUploading=false;
                resolve(data);
              } else {
                throw new Error(`Сервер: ${xhr.status}`);
              }
            } catch(err){
              isUploading=false;
              progressContainer.style.display='none';
              uploadBtn.classList.remove('hidden');
              reject(err);
            }
          }
        };

        xhr.onerror = ()=>{ isUploading=false; progressContainer.style.display='none'; uploadBtn.classList.remove('hidden'); reject(new Error('Ошибка сети')); };
        xhr.send(formData);
      });
    }

    function updateProgress(v){ progressFill.style.width = `${v}%`; progressPercent.textContent = `${v}%`; }

    function showToast(title, msg, type='success'){
      const toast=document.createElement('div');
      toast.className=`toast ${type==='error'?'error':''}`;
      toast.innerHTML=`<div class="toast-title">${title}</div><div class="toast-message">${msg}</div>`;
      document.body.appendChild(toast);
      setTimeout(()=>{ toast.classList.add('show'); setTimeout(()=>{ toast.classList.remove('show'); setTimeout(()=>toast.remove(),300); }, 5000); },100);
    }

    init();
  </script>
</body>
</html>
