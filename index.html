<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Загрузка файлов для проверки</title>
  <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
        .header { text-align: center; margin-bottom: 40px; color: white; }
        .header h1 {
            font-size: 2.5rem; font-weight: bold; margin-bottom: 16px;
            background: linear-gradient(45deg, #fff, #e0e7ff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .header p { font-size: 1.125rem; opacity: 0.9; max-width: 600px; margin: 0 auto; }
        .user-info {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 20px; margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2); color: white; display: none;
        }
        .user-info h3 { font-size: 0.875rem; font-weight: 500; margin-bottom: 8px; opacity: 0.8; }
        .user-info p { font-size: 0.875rem; margin: 4px 0; }
        .upload-zone {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border: 2px dashed #d1d5db; border-radius: 12px; padding: 60px 40px;
            text-align: center; cursor: pointer; transition: all 0.3s ease; margin-bottom: 30px;
        }
        .upload-zone:hover { border-color: #667eea; background: #fff; transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        .upload-zone.drag-over { border-color: #667eea; background: rgba(102, 126, 234, 0.1); transform: scale(1.02); }
        .upload-icon { width: 64px; height: 64px; margin: 0 auto 20px; background: #667eea;
            border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .upload-zone:hover .upload-icon { background: #5a67d8; transform: scale(1.1); }
        .upload-zone.drag-over .upload-icon { background: #667eea; transform: scale(1.2); }
        .upload-title { font-size: 1.25rem; font-weight: 600; color: #374151; margin-bottom: 8px; }
        .upload-subtitle { color: #6b7280; margin-bottom: 16px; }
        .upload-subtitle .highlight { color: #667eea; font-weight: 500; }
        .upload-formats { font-size: 0.875rem; color: #9ca3af; }
        .file-info {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 20px; margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3); display: none;
        }
        .progress-container {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 20px; margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3); display: none;
        }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-bottom: 8px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px; transition: width 0.3s ease; width: 0%; }
        .upload-btn {
            background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none;
            padding: 16px 32px; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); display: block; margin: 0 auto;
        }
        .upload-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6); }
        .upload-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .hidden { display: none !important; }
        .toast {
            position: fixed; top: 20px; right: 20px; background: white;
            border-radius: 8px; padding: 16px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #10b981; transform: translateX(400px);
            transition: transform 0.3s ease; z-index: 1000; max-width: 400px;
        }
        .toast.show { transform: translateX(0); }
        .toast.error { border-left-color: #ef4444; }
        .toast-title { font-weight: 600; color: #374151; margin-bottom: 4px; }
        .toast-message { color: #6b7280; font-size: 0.875rem; }
        #fileInput { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Загрузите файл для проверки</h1>
      <p>Выберите документ в формате PDF, TIFF, JPEG или PNG для анализа и проверки</p>
    </div>

    <div id="userInfo" class="user-info">
      <h3>Информация пользователя:</h3>
      <div id="userDetails"></div>
    </div>

    <div id="uploadZone" class="upload-zone">
      <div class="upload-icon">
        <svg width="32" height="32" fill="white" viewBox="0 0 24 24">
          <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
        </svg>
      </div>
      <h3 class="upload-title">Перетащите файл сюда</h3>
      <p class="upload-subtitle">или <span class="highlight">выберите файл</span> с компьютера</p>
      <p class="upload-formats">Поддерживаемые форматы: PDF, TIFF, JPEG, PNG (до 200MB)</p>
      <input type="file" id="fileInput" accept=".pdf,.tiff,.tif,.jpeg,.jpg,.png" multiple>
    </div>

    <div id="fileInfo" class="file-info"></div>

    <div id="progressContainer" class="progress-container">
      <div class="progress-header">
        <span class="progress-text">Загрузка файла...</span>
        <span class="progress-percent" id="progressPercent">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <p class="progress-filename" id="progressFilename"></p>
    </div>

    <button id="uploadBtn" class="upload-btn hidden">Отправить на проверку</button>
  </div>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- UTIF.js -->
  <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.min.js"></script>
  <!-- pdf-lib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

  <script>
    const WEBHOOK_URL = 'https://n8n.mdmprint.online/webhook/6a64b230-5b0c-46ad-b4d0-8830cbd95cc4';
    const ALLOWED_EXTENSIONS = ['pdf', 'tiff', 'tif', 'jpeg', 'jpg', 'png'];
    const MAX_FILE_SIZE = 200 * 1024 * 1024;

    let selectedFiles = [];
    let urlParams = { sides: 'one' };

    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const uploadBtn = document.getElementById('uploadBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressPercent = document.getElementById('progressPercent');
    const progressFilename = document.getElementById('progressFilename');
    const userInfo = document.getElementById('userInfo');
    const userDetails = document.getElementById('userDetails');

    function init() {
      const searchParams = new URLSearchParams(window.location.search);
      urlParams.sides = searchParams.get('sides') || 'one';
      if (urlParams.sides) {
        userDetails.innerHTML = `<p>Тип печати: ${urlParams.sides === 'one' ? 'Односторонняя' : 'Двусторонняя'}</p>`;
        userInfo.style.display = 'block';
      }
      uploadZone.addEventListener('click', () => fileInput.click());
      uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
      uploadZone.addEventListener('dragleave', e => { e.preventDefault(); uploadZone.classList.remove('drag-over'); });
      uploadZone.addEventListener('drop', handleDrop);
      fileInput.addEventListener('change', handleFileInputChange);
      uploadBtn.addEventListener('click', handleUpload);
    }

    function handleDrop(e) {
      e.preventDefault();
      uploadZone.classList.remove('drag-over');
      if (e.dataTransfer.files.length) processFiles(e.dataTransfer.files);
    }
    function handleFileInputChange(e) {
      if (e.target.files.length) processFiles(e.target.files);
    }

    async function processFiles(files) {
      selectedFiles = Array.from(files);
      if ((urlParams.sides === 'one' && selectedFiles.length > 1) || (urlParams.sides === 'two' && selectedFiles.length > 2)) {
        showToast('Ошибка', 'Загружено слишком много файлов', 'error');
        return;
      }
      fileInfo.innerHTML = selectedFiles.map(f => `<p>${f.name}</p>`).join('');
      fileInfo.style.display = 'block';
      uploadBtn.classList.remove('hidden');
      uploadZone.style.display = 'none';
    }

    async function convertToPDF(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      if (ext === 'pdf') {
        return new Uint8Array(await file.arrayBuffer());
      } else if (['jpg','jpeg','png'].includes(ext)) {
        const pdfDoc = await PDFLib.PDFDocument.create();
        const imgBytes = await file.arrayBuffer();
        let img;
        if (ext === 'png') img = await pdfDoc.embedPng(imgBytes);
        else img = await pdfDoc.embedJpg(imgBytes);
        const page = pdfDoc.addPage([img.width, img.height]);
        page.drawImage(img, { x:0, y:0, width:img.width, height:img.height });
        return await pdfDoc.save();
      } else if (['tif','tiff'].includes(ext)) {
        const arrayBuffer = await file.arrayBuffer();
        const ifds = UTIF.decode(arrayBuffer);
        const pdfDoc = await PDFLib.PDFDocument.create();
        for (let ifd of ifds) {
          UTIF.decodeImage(arrayBuffer, ifd);
          const rgba = UTIF.toRGBA8(ifd);
          const canvas = document.createElement('canvas');
          canvas.width = ifd.width; canvas.height = ifd.height;
          const ctx = canvas.getContext('2d');
          const imgData = ctx.createImageData(ifd.width, ifd.height);
          imgData.data.set(rgba);
          ctx.putImageData(imgData,0,0);
          const pngUrl = canvas.toDataURL('image/png');
          const pngImg = await pdfDoc.embedPng(await fetch(pngUrl).then(r=>r.arrayBuffer()));
          const page = pdfDoc.addPage([pngImg.width, pngImg.height]);
          page.drawImage(pngImg, {x:0, y:0, width:pngImg.width, height:pngImg.height});
        }
        return await pdfDoc.save();
      }
      throw new Error('Неподдерживаемый формат');
    }

    async function handleUpload() {
      if (!selectedFiles.length) return;
      progressContainer.style.display = 'block';
      progressFilename.textContent = selectedFiles.map(f=>f.name).join(', ');

      try {
        let mergedPdf;
        if (selectedFiles.length === 1) {
          mergedPdf = await convertToPDF(selectedFiles[0]);
        } else {
          const pdfDoc = await PDFLib.PDFDocument.create();
          for (let f of selectedFiles) {
            const pdfBytes = await convertToPDF(f);
            const tempDoc = await PDFLib.PDFDocument.load(pdfBytes);
            const copied = await pdfDoc.copyPages(tempDoc, tempDoc.getPageIndices());
            copied.forEach(p => pdfDoc.addPage(p));
          }
          mergedPdf = await pdfDoc.save();
        }

        const formData = new FormData();
        formData.append('file', new Blob([mergedPdf], {type:'application/pdf'}), 'file.pdf');
        const resp = await fetch(WEBHOOK_URL, {method:'POST', body:formData});
        if (resp.ok) showToast('Файл загружен', 'Отправлен на обработку');
        else throw new Error(`Сервер: ${resp.status}`);
      } catch(err) {
        showToast('Ошибка', err.message, 'error');
      }
    }

    function showToast(title, msg, type='success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type==='error'?'error':''}`;
      toast.innerHTML = `<div class="toast-title">${title}</div><div class="toast-message">${msg}</div>`;
      document.body.appendChild(toast);
      setTimeout(()=>{toast.classList.add('show'); setTimeout(()=>{toast.classList.remove('show'); setTimeout(()=>toast.remove(),300)},4000)},100);
    }

    init();
  </script>
</body>
</html>
